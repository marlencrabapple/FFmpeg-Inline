use Object::Pad qw(:experimental(:all));

package FFmpeg::Inline 0.01;
class FFmpeg::Inline;

use utf8;
use v5.40;

use Time::HiRes;
use Path::Tiny;
use Data::Printer;
use MIME::Base64;
use Data::Dumper;
use Syntax::Keyword::Try;
use Encode qw(encode decode);


our $code;
BEGIN {
  our $code = q{LyoKICogQ29weXJpZ2h0IChjKSAyMDEwIE5pY29sYXMgR2VvcmdlCiAqIENvcHlyaWdodCAoYykg
MjAxMSBTdGVmYW5vIFNhYmF0aW5pCiAqIENvcHlyaWdodCAoYykgMjAxNCBBbmRyZXkgVXRraW4K
ICoKICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFu
eSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lh
dGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogKiBpbiB0
aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRh
dGlvbiB0aGUgcmlnaHRzCiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwg
ZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICogY29waWVzIG9mIHRoZSBTb2Z0
d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAqIGZ1
cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAq
CiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNl
IHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlv
bnMgb2YgdGhlIFNvZnR3YXJlLgogKgogKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElT
IiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogKiBJTVBMSUVELCBJ
TkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJ
TElUWSwKICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdF
TUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwKICogVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERF
UlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZ
LCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFS
SVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUg
T1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqLwoKLyoq
CiAqIEBmaWxlIGRlbXV4aW5nLCBkZWNvZGluZywgZmlsdGVyaW5nLCBlbmNvZGluZyBhbmQgbXV4
aW5nIEFQSSB1c2FnZSBleGFtcGxlCiAqIEBleGFtcGxlIHRyYW5zY29kZS5jCiAqCiAqIENvbnZl
cnQgaW5wdXQgdG8gb3V0cHV0IGZpbGUsIGFwcGx5aW5nIHNvbWUgaGFyZC1jb2RlZCBmaWx0ZXIt
Z3JhcGggb24gYm90aAogKiBhdWRpbyBhbmQgdmlkZW8gc3RyZWFtcy4KICovCgojaW5jbHVkZSA8
bGliYXZjb2RlYy9hdmNvZGVjLmg+CiNpbmNsdWRlIDxsaWJhdmZvcm1hdC9hdmZvcm1hdC5oPgoj
aW5jbHVkZSA8bGliYXZmaWx0ZXIvYnVmZmVyc2luay5oPgojaW5jbHVkZSA8bGliYXZmaWx0ZXIv
YnVmZmVyc3JjLmg+CiNpbmNsdWRlIDxsaWJhdnV0aWwvY2hhbm5lbF9sYXlvdXQuaD4KI2luY2x1
ZGUgPGxpYmF2dXRpbC9tZW0uaD4KI2luY2x1ZGUgPGxpYmF2dXRpbC9vcHQuaD4KI2luY2x1ZGUg
PGxpYmF2dXRpbC9waXhkZXNjLmg+CgpzdGF0aWMgQVZGb3JtYXRDb250ZXh0ICppZm10X2N0eDsK
c3RhdGljIEFWRm9ybWF0Q29udGV4dCAqb2ZtdF9jdHg7CnR5cGVkZWYgc3RydWN0IEZpbHRlcmlu
Z0NvbnRleHQgewogICAgQVZGaWx0ZXJDb250ZXh0ICpidWZmZXJzaW5rX2N0eDsKICAgIEFWRmls
dGVyQ29udGV4dCAqYnVmZmVyc3JjX2N0eDsKICAgIEFWRmlsdGVyR3JhcGggKmZpbHRlcl9ncmFw
aDsKCiAgICBBVlBhY2tldCAqZW5jX3BrdDsKICAgIEFWRnJhbWUgKmZpbHRlcmVkX2ZyYW1lOwp9
IEZpbHRlcmluZ0NvbnRleHQ7CnN0YXRpYyBGaWx0ZXJpbmdDb250ZXh0ICpmaWx0ZXJfY3R4OwoK
dHlwZWRlZiBzdHJ1Y3QgU3RyZWFtQ29udGV4dCB7CiAgICBBVkNvZGVjQ29udGV4dCAqZGVjX2N0
eDsKICAgIEFWQ29kZWNDb250ZXh0ICplbmNfY3R4OwoKICAgIEFWRnJhbWUgKmRlY19mcmFtZTsK
fSBTdHJlYW1Db250ZXh0OwpzdGF0aWMgU3RyZWFtQ29udGV4dCAqc3RyZWFtX2N0eDsKCi8qIFVz
ZWQgYnkgdGhlIElOUFVUIHR5cGVtYXAgZm9yIGNoYXIqKi4KICogV2lsbCBjb252ZXJ0IGEgUGVy
bCBBViogKGNvbnRhaW5pbmcgc3RyaW5ncykgdG8gYSBDIGNoYXIqKi4KICovCmNoYXIgKioKWFNf
dW5wYWNrX2NoYXJQdHJQdHIoIHJ2ICkKU1YgKnJ2Owp7CiAgICAgICAgQVYgKmF2OwogICAgICAg
IFNWICoqc3N2OwogICAgICAgIGNoYXIgKipzOwogICAgICAgIGludCBhdmxlbjsKICAgICAgICBp
bnQgeDsKICAgICAgICBpZiggU3ZST0soIHJ2ICkgJiYgKFN2VFlQRShTdlJWKHJ2KSkgPT0gU1Z0
X1BWQVYpICkKICAgICAgICAgICAgICAgIGF2ID0gKEFWKilTdlJWKHJ2KTsKICAgICAgICBlbHNl
IHsKICAgICAgICAgICAgICAgIHdhcm4oIlhTX3VucGFja19jaGFyUHRyUHRyOiBydiB3YXMgbm90
IGFuIEFWIHJlZiIpOwogICAgICAgICAgICAgICAgcmV0dXJuKCAoY2hhcioqKU5VTEwgKTsKICAg
ICAgICB9CiAgICAgICAgLyogaXMgaXQgZW1wdHk/ICovCiAgICAgICAgYXZsZW4gPSBhdl9sZW4o
YXYpOwogICAgICAgIGlmKCBhdmxlbiA8IDAgKXsKICAgICAgICAgICAgICAgIHdhcm4oIlhTX3Vu
cGFja19jaGFyUHRyUHRyOiBhcnJheSB3YXMgZW1wdHkiKTsKICAgICAgICAgICAgICAgIHJldHVy
biggKGNoYXIqKilOVUxMICk7CiAgICAgICAgfQogICAgICAgIC8qIGF2X2xlbisyID09IG51bWJl
ciBvZiBzdHJpbmdzLCBwbHVzIDEgZm9yIGFuIGVuZC1vZi1hcnJheSBzZW50aW5lbC4KICAgICAg
ICAgKi8KICAgICAgICBzID0gKGNoYXIgKiopc2FmZW1hbGxvYyggc2l6ZW9mKGNoYXIqKSAqIChh
dmxlbiArIDIpICk7CiAgICAgICAgaWYoIHMgPT0gTlVMTCApewogICAgICAgICAgICAgICAgd2Fy
bigiWFNfdW5wYWNrX2NoYXJQdHJQdHI6IHVuYWJsZSB0byBtYWxsb2MgY2hhcioqIik7CiAgICAg
ICAgICAgICAgICByZXR1cm4oIChjaGFyKiopTlVMTCApOwogICAgICAgIH0KICAgICAgICBmb3Io
IHggPSAwOyB4IDw9IGF2bGVuOyArK3ggKXsKICAgICAgICAgICAgICAgIHNzdiA9IGF2X2ZldGNo
KCBhdiwgeCwgMCApOwogICAgICAgICAgICAgICAgaWYoIHNzdiAhPSBOVUxMICl7CiAgICAgICAg
ICAgICAgICAgICAgICAgIGlmKCBTdlBPSyggKnNzdiApICl7CiAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgc1t4XSA9IChjaGFyICopc2FmZW1hbGxvYyggU3ZDVVIoKnNzdikgKyAxICk7
CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIHNbeF0gPT0gTlVMTCApCiAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXJuKCJYU191bnBhY2tfY2hhclB0
clB0cjogdW5hYmxlIHRvIG1hbGxvYyBjaGFyKiIpOwogICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmNw
eSggc1t4XSwgU3ZQVl9ub2xlbigqc3N2KSApOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAg
ICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICB3YXJuKCJYU191bnBhY2tfY2hhclB0clB0cjogYXJyYXkgZWxlbSAlZCB3YXMgbm90IGEgc3Ry
aW5nLiIsIHggKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAg
ICAgICAgICAgICAgICAgICAgc1t4XSA9IChjaGFyKilOVUxMOwogICAgICAgIH0KICAgICAgICBz
W3hdID0gKGNoYXIqKU5VTEw7IC8qIHNlbnRpbmVsICovCiAgICAgICAgcmV0dXJuKCBzICk7Cn0K
LyogVXNlZCBieSB0aGUgT1VUUFVUIHR5cGVtYXAgZm9yIGNoYXIqKi4KICogV2lsbCBjb252ZXJ0
IGEgQyBjaGFyKiogdG8gYSBQZXJsIEFWKi4KICovCnZvaWQKWFNfcGFja19jaGFyUHRyUHRyKCBz
dCwgcyApClNWICpzdDsKY2hhciAqKnM7CnsKICAgICAgICBBViAqYXYgPSBuZXdBVigpOwogICAg
ICAgIFNWICpzdjsKICAgICAgICBjaGFyICoqYzsKICAgICAgICBmb3IoIGMgPSBzOyAqYyAhPSBO
VUxMOyArK2MgKXsKICAgICAgICAgICAgICAgIHN2ID0gbmV3U1ZwdiggKmMsIDAgKTsKICAgICAg
ICAgICAgICAgIGF2X3B1c2goIGF2LCBzdiApOwogICAgICAgIH0KICAgICAgICBzdiA9IG5ld1NW
cnYoIHN0LCBOVUxMICk7ICAgICAgIC8qIHVwZ3JhZGUgc3RhY2sgU1YgdG8gYW4gUlYgKi8KICAg
ICAgICBTdlJFRkNOVF9kZWMoIHN2ICk7ICAgICAvKiBkaXNjYXJkICovCiAgICAgICAgU3ZSVigg
c3QgKSA9IChTViopYXY7ICAgLyogbWFrZSBzdGFjayBSViBwb2ludCBhdCBvdXIgQVYgKi8KfQov
KiBjbGVhbnVwIHRoZSB0ZW1wb3JhcnkgY2hhcioqIGZyb20gWFNfdW5wYWNrX2NoYXJQdHJQdHIg
Ki8Kdm9pZApYU19yZWxlYXNlX2NoYXJQdHJQdHIocykKY2hhciAqKnM7CnsKICAgICAgICBjaGFy
ICoqYzsKICAgICAgICBmb3IoIGMgPSBzOyAqYyAhPSBOVUxMOyArK2MgKQogICAgICAgICAgICAg
ICAgc2FmZWZyZWUoICpjICk7CiAgICAgICAgc2FmZWZyZWUoIHMgKTsKfQoKc3RhdGljIGludCBv
cGVuX2lucHV0X2ZpbGUoY29uc3QgY2hhciAqZmlsZW5hbWUpCnsKICAgIGludCByZXQ7CiAgICB1
bnNpZ25lZCBpbnQgaTsKCiAgICBpZm10X2N0eCA9IE5VTEw7CiAgICBpZiAoKHJldCA9IGF2Zm9y
bWF0X29wZW5faW5wdXQoJmlmbXRfY3R4LCBmaWxlbmFtZSwgTlVMTCwgTlVMTCkpIDwgMCkgewog
ICAgICAgIGF2X2xvZyhOVUxMLCBBVl9MT0dfRVJST1IsICJDYW5ub3Qgb3BlbiBpbnB1dCBmaWxl
XG4iKTsKICAgICAgICByZXR1cm4gcmV0OwogICAgfQoKICAgIGlmICgocmV0ID0gYXZmb3JtYXRf
ZmluZF9zdHJlYW1faW5mbyhpZm10X2N0eCwgTlVMTCkpIDwgMCkgewogICAgICAgIGF2X2xvZyhO
VUxMLCBBVl9MT0dfRVJST1IsICJDYW5ub3QgZmluZCBzdHJlYW0gaW5mb3JtYXRpb25cbiIpOwog
ICAgICAgIHJldHVybiByZXQ7CiAgICB9CgogICAgc3RyZWFtX2N0eCA9IGF2X2NhbGxvYyhpZm10
X2N0eC0+bmJfc3RyZWFtcywgc2l6ZW9mKCpzdHJlYW1fY3R4KSk7CiAgICBpZiAoIXN0cmVhbV9j
dHgpCiAgICAgICAgcmV0dXJuIEFWRVJST1IoRU5PTUVNKTsKCiAgICBmb3IgKGkgPSAwOyBpIDwg
aWZtdF9jdHgtPm5iX3N0cmVhbXM7IGkrKykgewogICAgICAgIEFWU3RyZWFtICpzdHJlYW0gPSBp
Zm10X2N0eC0+c3RyZWFtc1tpXTsKICAgICAgICBjb25zdCBBVkNvZGVjICpkZWMgPSBhdmNvZGVj
X2ZpbmRfZGVjb2RlcihzdHJlYW0tPmNvZGVjcGFyLT5jb2RlY19pZCk7CiAgICAgICAgQVZDb2Rl
Y0NvbnRleHQgKmNvZGVjX2N0eDsKICAgICAgICBpZiAoIWRlYykgewogICAgICAgICAgICBhdl9s
b2coTlVMTCwgQVZfTE9HX0VSUk9SLCAiRmFpbGVkIHRvIGZpbmQgZGVjb2RlciBmb3Igc3RyZWFt
ICMldVxuIiwgaSk7CiAgICAgICAgICAgIHJldHVybiBBVkVSUk9SX0RFQ09ERVJfTk9UX0ZPVU5E
OwogICAgICAgIH0KICAgICAgICBjb2RlY19jdHggPSBhdmNvZGVjX2FsbG9jX2NvbnRleHQzKGRl
Yyk7CiAgICAgICAgaWYgKCFjb2RlY19jdHgpIHsKICAgICAgICAgICAgYXZfbG9nKE5VTEwsIEFW
X0xPR19FUlJPUiwgIkZhaWxlZCB0byBhbGxvY2F0ZSB0aGUgZGVjb2RlciBjb250ZXh0IGZvciBz
dHJlYW0gIyV1XG4iLCBpKTsKICAgICAgICAgICAgcmV0dXJuIEFWRVJST1IoRU5PTUVNKTsKICAg
ICAgICB9CiAgICAgICAgcmV0ID0gYXZjb2RlY19wYXJhbWV0ZXJzX3RvX2NvbnRleHQoY29kZWNf
Y3R4LCBzdHJlYW0tPmNvZGVjcGFyKTsKICAgICAgICBpZiAocmV0IDwgMCkgewogICAgICAgICAg
ICBhdl9sb2coTlVMTCwgQVZfTE9HX0VSUk9SLCAiRmFpbGVkIHRvIGNvcHkgZGVjb2RlciBwYXJh
bWV0ZXJzIHRvIGlucHV0IGRlY29kZXIgY29udGV4dCAiCiAgICAgICAgICAgICAgICAgICAiZm9y
IHN0cmVhbSAjJXVcbiIsIGkpOwogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH0KCiAg
ICAgICAgLyogSW5mb3JtIHRoZSBkZWNvZGVyIGFib3V0IHRoZSB0aW1lYmFzZSBmb3IgdGhlIHBh
Y2tldCB0aW1lc3RhbXBzLgogICAgICAgICAqIFRoaXMgaXMgaGlnaGx5IHJlY29tbWVuZGVkLCBi
dXQgbm90IG1hbmRhdG9yeS4gKi8KICAgICAgICBjb2RlY19jdHgtPnBrdF90aW1lYmFzZSA9IHN0
cmVhbS0+dGltZV9iYXNlOwoKICAgICAgICAvKiBSZWVuY29kZSB2aWRlbyAmIGF1ZGlvIGFuZCBy
ZW11eCBzdWJ0aXRsZXMgZXRjLiAqLwogICAgICAgIGlmIChjb2RlY19jdHgtPmNvZGVjX3R5cGUg
PT0gQVZNRURJQV9UWVBFX1ZJREVPCiAgICAgICAgICAgICAgICB8fCBjb2RlY19jdHgtPmNvZGVj
X3R5cGUgPT0gQVZNRURJQV9UWVBFX0FVRElPKSB7CiAgICAgICAgICAgIGlmIChjb2RlY19jdHgt
PmNvZGVjX3R5cGUgPT0gQVZNRURJQV9UWVBFX1ZJREVPKQogICAgICAgICAgICAgICAgY29kZWNf
Y3R4LT5mcmFtZXJhdGUgPSBhdl9ndWVzc19mcmFtZV9yYXRlKGlmbXRfY3R4LCBzdHJlYW0sIE5V
TEwpOwogICAgICAgICAgICAvKiBPcGVuIGRlY29kZXIgKi8KICAgICAgICAgICAgcmV0ID0gYXZj
b2RlY19vcGVuMihjb2RlY19jdHgsIGRlYywgTlVMTCk7CiAgICAgICAgICAgIGlmIChyZXQgPCAw
KSB7CiAgICAgICAgICAgICAgICBhdl9sb2coTlVMTCwgQVZfTE9HX0VSUk9SLCAiRmFpbGVkIHRv
IG9wZW4gZGVjb2RlciBmb3Igc3RyZWFtICMldVxuIiwgaSk7CiAgICAgICAgICAgICAgICByZXR1
cm4gcmV0OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHN0cmVhbV9jdHhbaV0uZGVj
X2N0eCA9IGNvZGVjX2N0eDsKCiAgICAgICAgc3RyZWFtX2N0eFtpXS5kZWNfZnJhbWUgPSBhdl9m
cmFtZV9hbGxvYygpOwogICAgICAgIGlmICghc3RyZWFtX2N0eFtpXS5kZWNfZnJhbWUpCiAgICAg
ICAgICAgIHJldHVybiBBVkVSUk9SKEVOT01FTSk7CiAgICB9CgogICAgYXZfZHVtcF9mb3JtYXQo
aWZtdF9jdHgsIDAsIGZpbGVuYW1lLCAwKTsKICAgIHJldHVybiAwOwp9CgpzdGF0aWMgaW50IG9w
ZW5fb3V0cHV0X2ZpbGUoY29uc3QgY2hhciAqZmlsZW5hbWUsIHVuc2lnbmVkIGludCBtYXhfdywg
dW5zaWduZWQgaW50IG1heF9oKQp7CiAgICBBVlN0cmVhbSAqb3V0X3N0cmVhbTsKICAgIEFWU3Ry
ZWFtICppbl9zdHJlYW07CiAgICBBVkNvZGVjQ29udGV4dCAqZGVjX2N0eCwgKmVuY19jdHg7CiAg
ICBjb25zdCBBVkNvZGVjICplbmNvZGVyOwogICAgaW50IHJldDsKICAgIHVuc2lnbmVkIGludCBp
OwoKICAgIG9mbXRfY3R4ID0gTlVMTDsKICAgIGF2Zm9ybWF0X2FsbG9jX291dHB1dF9jb250ZXh0
Migmb2ZtdF9jdHgsIE5VTEwsIE5VTEwsIGZpbGVuYW1lKTsKICAgIGlmICghb2ZtdF9jdHgpIHsK
ICAgICAgICBhdl9sb2coTlVMTCwgQVZfTE9HX0VSUk9SLCAiQ291bGQgbm90IGNyZWF0ZSBvdXRw
dXQgY29udGV4dFxuIik7CiAgICAgICAgcmV0dXJuIEFWRVJST1JfVU5LTk9XTjsKICAgIH0KCgog
ICAgZm9yIChpID0gMDsgaSA8IGlmbXRfY3R4LT5uYl9zdHJlYW1zOyBpKyspIHsKCiAgICAgICAg
aW5fc3RyZWFtID0gaWZtdF9jdHgtPnN0cmVhbXNbaV07CiAgICAgICAgZGVjX2N0eCA9IHN0cmVh
bV9jdHhbaV0uZGVjX2N0eDsKICAgICAgICAKICAgICAgICBpZiAoZGVjX2N0eC0+Y29kZWNfdHlw
ZSAhPSBBVk1FRElBX1RZUEVfVklERU8pIHsKICAgICAgICAgICAgYXZjb2RlY19mcmVlX2NvbnRl
eHQoJnN0cmVhbV9jdHhbaV0uZGVjX2N0eCk7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAg
IH0KCiAgICAgICAgb3V0X3N0cmVhbSA9IGF2Zm9ybWF0X25ld19zdHJlYW0ob2ZtdF9jdHgsIE5V
TEwpOwogICAgICAgIGlmICghb3V0X3N0cmVhbSkgewogICAgICAgICAgICBhdl9sb2coTlVMTCwg
QVZfTE9HX0VSUk9SLCAiRmFpbGVkIGFsbG9jYXRpbmcgb3V0cHV0IHN0cmVhbVxuIik7CiAgICAg
ICAgICAgIHJldHVybiBBVkVSUk9SX1VOS05PV047CiAgICAgICAgfQoKIAogICAgICAgIGlmIChk
ZWNfY3R4LT5jb2RlY190eXBlID09IEFWTUVESUFfVFlQRV9WSURFTykgewoJICAgICAgICBlbmNv
ZGVyID0gYXZjb2RlY19maW5kX2VuY29kZXIoQVZfQ09ERUNfSURfQVYxKTsKCiAgICAgICAgICAg
IGlmICghZW5jb2RlcikgewogICAgICAgICAgICAgICAgYXZfbG9nKE5VTEwsIEFWX0xPR19GQVRB
TCwgIk5lY2Vzc2FyeSBlbmNvZGVyIG5vdCBmb3VuZFxuIik7CiAgICAgICAgICAgICAgICByZXR1
cm4gQVZFUlJPUl9JTlZBTElEREFUQTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbmNfY3R4
ID0gYXZjb2RlY19hbGxvY19jb250ZXh0MyhlbmNvZGVyKTsKICAgICAgICAgICAgaWYgKCFlbmNf
Y3R4KSB7CiAgICAgICAgICAgICAgICBhdl9sb2coTlVMTCwgQVZfTE9HX0ZBVEFMLCAiRmFpbGVk
IHRvIGFsbG9jYXRlIHRoZSBlbmNvZGVyIGNvbnRleHRcbiIpOwogICAgICAgICAgICAgICAgcmV0
dXJuIEFWRVJST1IoRU5PTUVNKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyogSW4gdGhp
cyBleGFtcGxlLCB3ZSB0cmFuc2NvZGUgdG8gc2FtZSBwcm9wZXJ0aWVzIChwaWN0dXJlIHNpemUs
CiAgICAgICAgICAgICAqIHNhbXBsZSByYXRlIGV0Yy4pLiBUaGVzZSBwcm9wZXJ0aWVzIGNhbiBi
ZSBjaGFuZ2VkIGZvciBvdXRwdXQKICAgICAgICAgICAgICogc3RyZWFtcyBlYXNpbHkgdXNpbmcg
ZmlsdGVycyAqLwogICAgICAgICAgICBpZiAoZGVjX2N0eC0+Y29kZWNfdHlwZSA9PSBBVk1FRElB
X1RZUEVfVklERU8pIHsKICAgICAgICAgICAgICAgIGNvbnN0IGVudW0gQVZQaXhlbEZvcm1hdCAq
cGl4X2ZtdHMgPSBOVUxMOwoKICAgICAgICAgICAgICAgIGlmIChkZWNfY3R4LT53aWR0aCA8PSBt
YXhfdyAmJiBkZWNfY3R4LT5oZWlnaHQgPD0gbWF4X2gpIHsKICAgICAgICAgICAgICAgICAgICAg
ICAgZW5jX2N0eC0+d2lkdGggPSBkZWNfY3R4LT53aWR0aDsgICAgCiAgICAgICAgICAgICAgICAg
ICAgICAgIGVuY19jdHgtPmhlaWdodCA9IGRlY19jdHgtPmhlaWdodDsKICAgICAgICAgICAgICAg
ICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZW5j
X2N0eC0+d2lkdGggPSBtYXhfdzsKICAgICAgICAgICAgICAgICAgICBlbmNfY3R4LT5oZWlnaHQg
PSAoaW50KSAoKGRlY19jdHgtPmhlaWdodCAqIG1heF93KSAvIGRlY19jdHgtPndpZHRoKTsKCiAg
ICAgICAgICAgICAgICAgICAgaWYgKGVuY19jdHgtPmhlaWdodCA+IG1heF9oKSB7CiAgICAgICAg
ICAgICAgICAgICAgICAgIGVuY19jdHgtPndpZHRoID0gKGludCkgKChkZWNfY3R4LT53aWR0aCAq
IG1heF9oKSAvIGRlY19jdHgtPmhlaWdodCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVuY19j
dHgtPmhlaWdodCA9IG1heF9oOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAg
IH0KCiAgICAgICAgICAgICAgICAvKiB0YWtlIGZpcnN0IGZvcm1hdCBmcm9tIGxpc3Qgb2Ygc3Vw
cG9ydGVkIGZvcm1hdHMgKi8KICAgICAgICAgICAgICAgIGVuY19jdHgtPnBpeF9mbXQgPSAocmV0
ID49IDAgJiYgcGl4X2ZtdHMpID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBw
aXhfZm10c1swXSA6IGRlY19jdHgtPnBpeF9mbXQ7CgogICAgICAgICAgICAgICAgLyogdmlkZW8g
dGltZV9iYXNlIGNhbiBiZSBzZXQgdG8gd2hhdGV2ZXIgaXMgaGFuZHkgYW5kIHN1cHBvcnRlZCBi
eSBlbmNvZGVyICovCiAgICAgICAgICAgICAgICBlbmNfY3R4LT50aW1lX2Jhc2UgPSBhdl9pbnZf
cShkZWNfY3R4LT5mcmFtZXJhdGUpOwogICAgICAgICAgICAgfSAKCiAgICAgICAgICAgIGlmIChv
Zm10X2N0eC0+b2Zvcm1hdC0+ZmxhZ3MgJiBBVkZNVF9HTE9CQUxIRUFERVIpCiAgICAgICAgICAg
ICAgICBlbmNfY3R4LT5mbGFncyB8PSBBVl9DT0RFQ19GTEFHX0dMT0JBTF9IRUFERVI7CgogICAg
ICAgICAgICAvKiBUaGlyZCBwYXJhbWV0ZXIgY2FuIGJlIHVzZWQgdG8gcGFzcyBzZXR0aW5ncyB0
byBlbmNvZGVyICovCiAgICAgICAgICAgIHJldCA9IGF2Y29kZWNfb3BlbjIoZW5jX2N0eCwgZW5j
b2RlciwgTlVMTCk7CiAgICAgICAgICAgIGlmIChyZXQgPCAwKSB7CiAgICAgICAgICAgICAgICBh
dl9sb2coTlVMTCwgQVZfTE9HX0VSUk9SLCAiQ2Fubm90IG9wZW4gJXMgZW5jb2RlciBmb3Igc3Ry
ZWFtICMldVxuIiwgZW5jb2Rlci0+bmFtZSwgaSk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmV0
OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldCA9IGF2Y29kZWNfcGFyYW1ldGVyc19mcm9t
X2NvbnRleHQob3V0X3N0cmVhbS0+Y29kZWNwYXIsIGVuY19jdHgpOwogICAgICAgICAgICBpZiAo
cmV0IDwgMCkgewogICAgICAgICAgICAgICAgYXZfbG9nKE5VTEwsIEFWX0xPR19FUlJPUiwgIkZh
aWxlZCB0byBjb3B5IGVuY29kZXIgcGFyYW1ldGVycyB0byBvdXRwdXQgc3RyZWFtICMldVxuIiwg
aSk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgICB9CgogICAgICAgICAg
ICBvdXRfc3RyZWFtLT50aW1lX2Jhc2UgPSBlbmNfY3R4LT50aW1lX2Jhc2U7CiAgICAgICAgICAg
IHN0cmVhbV9jdHhbaV0uZW5jX2N0eCA9IGVuY19jdHg7CiAgICAgICAgfQogICAgfQogICAgYXZf
ZHVtcF9mb3JtYXQob2ZtdF9jdHgsIDAsIGZpbGVuYW1lLCAxKTsKCiAgICBpZiAoIShvZm10X2N0
eC0+b2Zvcm1hdC0+ZmxhZ3MgJiBBVkZNVF9OT0ZJTEUpKSB7CiAgICAgICAgcmV0ID0gYXZpb19v
cGVuKCZvZm10X2N0eC0+cGIsIGZpbGVuYW1lLCBBVklPX0ZMQUdfV1JJVEUpOwogICAgICAgIGlm
IChyZXQgPCAwKSB7CiAgICAgICAgICAgIGF2X2xvZyhOVUxMLCBBVl9MT0dfRVJST1IsICJDb3Vs
ZCBub3Qgb3BlbiBvdXRwdXQgZmlsZSAnJXMnIiwgZmlsZW5hbWUpOwogICAgICAgICAgICByZXR1
cm4gcmV0OwogICAgICAgIH0KICAgIH0KCiAgICAvKiBpbml0IG11eGVyLCB3cml0ZSBvdXRwdXQg
ZmlsZSBoZWFkZXIgKi8KICAgIHJldCA9IGF2Zm9ybWF0X3dyaXRlX2hlYWRlcihvZm10X2N0eCwg
TlVMTCk7CiAgICBpZiAocmV0IDwgMCkgewogICAgICAgIGF2X2xvZyhOVUxMLCBBVl9MT0dfRVJS
T1IsICJFcnJvciBvY2N1cnJlZCB3aGVuIG9wZW5pbmcgb3V0cHV0IGZpbGVcbiIpOwogICAgICAg
IHJldHVybiByZXQ7CiAgICB9CgogICAgcmV0dXJuIDA7Cn0KCnN0YXRpYyBpbnQgaW5pdF9maWx0
ZXIoRmlsdGVyaW5nQ29udGV4dCogZmN0eCwgQVZDb2RlY0NvbnRleHQgKmRlY19jdHgsCiAgICAg
ICAgQVZDb2RlY0NvbnRleHQgKmVuY19jdHgsIGNvbnN0IGNoYXIgKmZpbHRlcl9zcGVjKQp7CiAg
ICBjaGFyIGFyZ3NbNTEyXTsKICAgIGludCByZXQgPSAwOwogICAgY29uc3QgQVZGaWx0ZXIgKmJ1
ZmZlcnNyYyA9IE5VTEw7CiAgICBjb25zdCBBVkZpbHRlciAqYnVmZmVyc2luayA9IE5VTEw7CiAg
ICBBVkZpbHRlckNvbnRleHQgKmJ1ZmZlcnNyY19jdHggPSBOVUxMOwogICAgQVZGaWx0ZXJDb250
ZXh0ICpidWZmZXJzaW5rX2N0eCA9IE5VTEw7CiAgICBBVkZpbHRlckluT3V0ICpvdXRwdXRzID0g
YXZmaWx0ZXJfaW5vdXRfYWxsb2MoKTsKICAgIEFWRmlsdGVySW5PdXQgKmlucHV0cyAgPSBhdmZp
bHRlcl9pbm91dF9hbGxvYygpOwogICAgQVZGaWx0ZXJHcmFwaCAqZmlsdGVyX2dyYXBoID0gYXZm
aWx0ZXJfZ3JhcGhfYWxsb2MoKTsKCiAgICBpZiAoIW91dHB1dHMgfHwgIWlucHV0cyB8fCAhZmls
dGVyX2dyYXBoKSB7CiAgICAgICAgcmV0ID0gQVZFUlJPUihFTk9NRU0pOwogICAgICAgIGdvdG8g
ZW5kOwogICAgfQoKICAgIGlmIChkZWNfY3R4LT5jb2RlY190eXBlID09IEFWTUVESUFfVFlQRV9W
SURFTykgewogICAgICAgIGJ1ZmZlcnNyYyA9IGF2ZmlsdGVyX2dldF9ieV9uYW1lKCJidWZmZXIi
KTsKICAgICAgICBidWZmZXJzaW5rID0gYXZmaWx0ZXJfZ2V0X2J5X25hbWUoImJ1ZmZlcnNpbmsi
KTsKICAgICAgICBpZiAoIWJ1ZmZlcnNyYyB8fCAhYnVmZmVyc2luaykgewogICAgICAgICAgICBh
dl9sb2coTlVMTCwgQVZfTE9HX0VSUk9SLCAiZmlsdGVyaW5nIHNvdXJjZSBvciBzaW5rIGVsZW1l
bnQgbm90IGZvdW5kXG4iKTsKICAgICAgICAgICAgcmV0ID0gQVZFUlJPUl9VTktOT1dOOwogICAg
ICAgICAgICBnb3RvIGVuZDsKICAgICAgICB9CgogICAgICAgIHNucHJpbnRmKGFyZ3MsIHNpemVv
ZihhcmdzKSwKICAgICAgICAgICAgICAgICJ2aWRlb19zaXplPSVkeCVkOnBpeF9mbXQ9JWQ6dGlt
ZV9iYXNlPSVkLyVkOnBpeGVsX2FzcGVjdD0lZC8lZCIsCiAgICAgICAgICAgICAgICBkZWNfY3R4
LT53aWR0aCwgZGVjX2N0eC0+aGVpZ2h0LCBkZWNfY3R4LT5waXhfZm10LAogICAgICAgICAgICAg
ICAgZGVjX2N0eC0+cGt0X3RpbWViYXNlLm51bSwgZGVjX2N0eC0+cGt0X3RpbWViYXNlLmRlbiwK
ICAgICAgICAgICAgICAgIGRlY19jdHgtPnNhbXBsZV9hc3BlY3RfcmF0aW8ubnVtLAogICAgICAg
ICAgICAgICAgZGVjX2N0eC0+c2FtcGxlX2FzcGVjdF9yYXRpby5kZW4pOwoKICAgICAgICByZXQg
PSBhdmZpbHRlcl9ncmFwaF9jcmVhdGVfZmlsdGVyKCZidWZmZXJzcmNfY3R4LCBidWZmZXJzcmMs
ICJpbiIsCiAgICAgICAgICAgICAgICBhcmdzLCBOVUxMLCBmaWx0ZXJfZ3JhcGgpOwogICAgICAg
IGlmIChyZXQgPCAwKSB7CiAgICAgICAgICAgIGF2X2xvZyhOVUxMLCBBVl9MT0dfRVJST1IsICJD
YW5ub3QgY3JlYXRlIGJ1ZmZlciBzb3VyY2VcbiIpOwogICAgICAgICAgICBnb3RvIGVuZDsKICAg
ICAgICB9CgogICAgICAgIGJ1ZmZlcnNpbmtfY3R4ID0gYXZmaWx0ZXJfZ3JhcGhfYWxsb2NfZmls
dGVyKGZpbHRlcl9ncmFwaCwgYnVmZmVyc2luaywgIm91dCIpOwogICAgICAgIGlmICghYnVmZmVy
c2lua19jdHgpIHsKICAgICAgICAgICAgYXZfbG9nKE5VTEwsIEFWX0xPR19FUlJPUiwgIkNhbm5v
dCBjcmVhdGUgYnVmZmVyIHNpbmtcbiIpOwogICAgICAgICAgICByZXQgPSBBVkVSUk9SKEVOT01F
TSk7CiAgICAgICAgICAgIGdvdG8gZW5kOwogICAgICAgIH0KCiAgICAgICAgcmV0ID0gYXZfb3B0
X3NldF9iaW4oYnVmZmVyc2lua19jdHgsICJwaXhfZm10cyIsCiAgICAgICAgICAgICAgICAodWlu
dDhfdCopJmVuY19jdHgtPnBpeF9mbXQsIHNpemVvZihlbmNfY3R4LT5waXhfZm10KSwKICAgICAg
ICAgICAgICAgIEFWX09QVF9TRUFSQ0hfQ0hJTERSRU4pOwogICAgICAgIGlmIChyZXQgPCAwKSB7
CiAgICAgICAgICAgIGF2X2xvZyhOVUxMLCBBVl9MT0dfRVJST1IsICJDYW5ub3Qgc2V0IG91dHB1
dCBwaXhlbCBmb3JtYXRcbiIpOwogICAgICAgICAgICBnb3RvIGVuZDsKICAgICAgICB9CgogICAg
ICAgIHJldCA9IGF2ZmlsdGVyX2luaXRfZGljdChidWZmZXJzaW5rX2N0eCwgTlVMTCk7CiAgICAg
ICAgaWYgKHJldCA8IDApIHsKICAgICAgICAgICAgYXZfbG9nKE5VTEwsIEFWX0xPR19FUlJPUiwg
IkNhbm5vdCBpbml0aWFsaXplIGJ1ZmZlciBzaW5rXG4iKTsKICAgICAgICAgICAgZ290byBlbmQ7
CiAgICAgICAgfQogICAgfSBlbHNlIGlmIChkZWNfY3R4LT5jb2RlY190eXBlID09IEFWTUVESUFf
VFlQRV9BVURJTykgewogICAgICAgIGdvdG8gZW5kOwogICAgICAgIGNoYXIgYnVmWzY0XTsKICAg
ICAgICBidWZmZXJzcmMgPSBhdmZpbHRlcl9nZXRfYnlfbmFtZSgiYWJ1ZmZlciIpOwogICAgICAg
IGJ1ZmZlcnNpbmsgPSBhdmZpbHRlcl9nZXRfYnlfbmFtZSgiYWJ1ZmZlcnNpbmsiKTsKICAgICAg
ICBpZiAoIWJ1ZmZlcnNyYyB8fCAhYnVmZmVyc2luaykgewogICAgICAgICAgICBhdl9sb2coTlVM
TCwgQVZfTE9HX0VSUk9SLCAiZmlsdGVyaW5nIHNvdXJjZSBvciBzaW5rIGVsZW1lbnQgbm90IGZv
dW5kXG4iKTsKICAgICAgICAgICAgcmV0ID0gQVZFUlJPUl9VTktOT1dOOwogICAgICAgICAgICBn
b3RvIGVuZDsKICAgICAgICB9CgogICAgICAgIGlmIChkZWNfY3R4LT5jaF9sYXlvdXQub3JkZXIg
PT0gQVZfQ0hBTk5FTF9PUkRFUl9VTlNQRUMpCiAgICAgICAgICAgIGF2X2NoYW5uZWxfbGF5b3V0
X2RlZmF1bHQoJmRlY19jdHgtPmNoX2xheW91dCwgZGVjX2N0eC0+Y2hfbGF5b3V0Lm5iX2NoYW5u
ZWxzKTsKICAgICAgICBhdl9jaGFubmVsX2xheW91dF9kZXNjcmliZSgmZGVjX2N0eC0+Y2hfbGF5
b3V0LCBidWYsIHNpemVvZihidWYpKTsKICAgICAgICBzbnByaW50ZihhcmdzLCBzaXplb2YoYXJn
cyksCiAgICAgICAgICAgICAgICAidGltZV9iYXNlPSVkLyVkOnNhbXBsZV9yYXRlPSVkOnNhbXBs
ZV9mbXQ9JXM6Y2hhbm5lbF9sYXlvdXQ9JXMiLAogICAgICAgICAgICAgICAgZGVjX2N0eC0+cGt0
X3RpbWViYXNlLm51bSwgZGVjX2N0eC0+cGt0X3RpbWViYXNlLmRlbiwgZGVjX2N0eC0+c2FtcGxl
X3JhdGUsCiAgICAgICAgICAgICAgICBhdl9nZXRfc2FtcGxlX2ZtdF9uYW1lKGRlY19jdHgtPnNh
bXBsZV9mbXQpLAogICAgICAgICAgICAgICAgYnVmKTsKICAgICAgICByZXQgPSBhdmZpbHRlcl9n
cmFwaF9jcmVhdGVfZmlsdGVyKCZidWZmZXJzcmNfY3R4LCBidWZmZXJzcmMsICJpbiIsCiAgICAg
ICAgICAgICAgICBhcmdzLCBOVUxMLCBmaWx0ZXJfZ3JhcGgpOwogICAgICAgIGlmIChyZXQgPCAw
KSB7CiAgICAgICAgICAgIGF2X2xvZyhOVUxMLCBBVl9MT0dfRVJST1IsICJDYW5ub3QgY3JlYXRl
IGF1ZGlvIGJ1ZmZlciBzb3VyY2VcbiIpOwogICAgICAgICAgICBnb3RvIGVuZDsKICAgICAgICB9
CgogICAgICAgIGJ1ZmZlcnNpbmtfY3R4ID0gYXZmaWx0ZXJfZ3JhcGhfYWxsb2NfZmlsdGVyKGZp
bHRlcl9ncmFwaCwgYnVmZmVyc2luaywgIm91dCIpOwogICAgICAgIGlmICghYnVmZmVyc2lua19j
dHgpIHsKICAgICAgICAgICAgYXZfbG9nKE5VTEwsIEFWX0xPR19FUlJPUiwgIkNhbm5vdCBjcmVh
dGUgYXVkaW8gYnVmZmVyIHNpbmtcbiIpOwogICAgICAgICAgICByZXQgPSBBVkVSUk9SKEVOT01F
TSk7CiAgICAgICAgICAgIGdvdG8gZW5kOwogICAgICAgIH0KCiAgICAgICAgcmV0ID0gYXZfb3B0
X3NldF9iaW4oYnVmZmVyc2lua19jdHgsICJzYW1wbGVfZm10cyIsCiAgICAgICAgICAgICAgICAo
dWludDhfdCopJmVuY19jdHgtPnNhbXBsZV9mbXQsIHNpemVvZihlbmNfY3R4LT5zYW1wbGVfZm10
KSwKICAgICAgICAgICAgICAgIEFWX09QVF9TRUFSQ0hfQ0hJTERSRU4pOwogICAgICAgIGlmIChy
ZXQgPCAwKSB7CiAgICAgICAgICAgIGF2X2xvZyhOVUxMLCBBVl9MT0dfRVJST1IsICJDYW5ub3Qg
c2V0IG91dHB1dCBzYW1wbGUgZm9ybWF0XG4iKTsKICAgICAgICAgICAgZ290byBlbmQ7CiAgICAg
ICAgfQoKICAgICAgICBhdl9jaGFubmVsX2xheW91dF9kZXNjcmliZSgmZW5jX2N0eC0+Y2hfbGF5
b3V0LCBidWYsIHNpemVvZihidWYpKTsKICAgICAgICByZXQgPSBhdl9vcHRfc2V0KGJ1ZmZlcnNp
bmtfY3R4LCAiY2hfbGF5b3V0cyIsCiAgICAgICAgICAgICAgICAgICAgICAgICBidWYsIEFWX09Q
VF9TRUFSQ0hfQ0hJTERSRU4pOwogICAgICAgIGlmIChyZXQgPCAwKSB7CiAgICAgICAgICAgIGF2
X2xvZyhOVUxMLCBBVl9MT0dfRVJST1IsICJDYW5ub3Qgc2V0IG91dHB1dCBjaGFubmVsIGxheW91
dFxuIik7CiAgICAgICAgICAgIGdvdG8gZW5kOwogICAgICAgIH0KCiAgICAgICAgcmV0ID0gYXZf
b3B0X3NldF9iaW4oYnVmZmVyc2lua19jdHgsICJzYW1wbGVfcmF0ZXMiLAogICAgICAgICAgICAg
ICAgKHVpbnQ4X3QqKSZlbmNfY3R4LT5zYW1wbGVfcmF0ZSwgc2l6ZW9mKGVuY19jdHgtPnNhbXBs
ZV9yYXRlKSwKICAgICAgICAgICAgICAgIEFWX09QVF9TRUFSQ0hfQ0hJTERSRU4pOwogICAgICAg
IGlmIChyZXQgPCAwKSB7CiAgICAgICAgICAgIGF2X2xvZyhOVUxMLCBBVl9MT0dfRVJST1IsICJD
YW5ub3Qgc2V0IG91dHB1dCBzYW1wbGUgcmF0ZVxuIik7CiAgICAgICAgICAgIGdvdG8gZW5kOwog
ICAgICAgIH0KCiAgICAgICAgaWYgKGVuY19jdHgtPmZyYW1lX3NpemUgPiAwKQogICAgICAgICAg
ICBhdl9idWZmZXJzaW5rX3NldF9mcmFtZV9zaXplKGJ1ZmZlcnNpbmtfY3R4LCBlbmNfY3R4LT5m
cmFtZV9zaXplKTsKCiAgICAgICAgcmV0ID0gYXZmaWx0ZXJfaW5pdF9kaWN0KGJ1ZmZlcnNpbmtf
Y3R4LCBOVUxMKTsKICAgICAgICBpZiAocmV0IDwgMCkgewogICAgICAgICAgICBhdl9sb2coTlVM
TCwgQVZfTE9HX0VSUk9SLCAiQ2Fubm90IGluaXRpYWxpemUgYXVkaW8gYnVmZmVyIHNpbmtcbiIp
OwogICAgICAgICAgICBnb3RvIGVuZDsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIHJl
dCA9IEFWRVJST1JfVU5LTk9XTjsKICAgICAgICBnb3RvIGVuZDsKICAgIH0KCiAgICAvKiBFbmRw
b2ludHMgZm9yIHRoZSBmaWx0ZXIgZ3JhcGguICovCiAgICBvdXRwdXRzLT5uYW1lICAgICAgID0g
YXZfc3RyZHVwKCJpbiIpOwogICAgb3V0cHV0cy0+ZmlsdGVyX2N0eCA9IGJ1ZmZlcnNyY19jdHg7
CiAgICBvdXRwdXRzLT5wYWRfaWR4ICAgID0gMDsKICAgIG91dHB1dHMtPm5leHQgICAgICAgPSBO
VUxMOwoKICAgIGlucHV0cy0+bmFtZSAgICAgICA9IGF2X3N0cmR1cCgib3V0Iik7CiAgICBpbnB1
dHMtPmZpbHRlcl9jdHggPSBidWZmZXJzaW5rX2N0eDsKICAgIGlucHV0cy0+cGFkX2lkeCAgICA9
IDA7CiAgICBpbnB1dHMtPm5leHQgICAgICAgPSBOVUxMOwoKICAgIGlmICghb3V0cHV0cy0+bmFt
ZSB8fCAhaW5wdXRzLT5uYW1lKSB7CiAgICAgICAgcmV0ID0gQVZFUlJPUihFTk9NRU0pOwogICAg
ICAgIGdvdG8gZW5kOwogICAgfQoKICAgIGlmICgocmV0ID0gYXZmaWx0ZXJfZ3JhcGhfcGFyc2Vf
cHRyKGZpbHRlcl9ncmFwaCwgZmlsdGVyX3NwZWMsCiAgICAgICAgICAgICAgICAgICAgJmlucHV0
cywgJm91dHB1dHMsIE5VTEwpKSA8IDApCiAgICAgICAgZ290byBlbmQ7CgogICAgaWYgKChyZXQg
PSBhdmZpbHRlcl9ncmFwaF9jb25maWcoZmlsdGVyX2dyYXBoLCBOVUxMKSkgPCAwKQogICAgICAg
IGdvdG8gZW5kOwoKICAgIC8qIEZpbGwgRmlsdGVyaW5nQ29udGV4dCAqLwogICAgZmN0eC0+YnVm
ZmVyc3JjX2N0eCA9IGJ1ZmZlcnNyY19jdHg7CiAgICBmY3R4LT5idWZmZXJzaW5rX2N0eCA9IGJ1
ZmZlcnNpbmtfY3R4OwogICAgZmN0eC0+ZmlsdGVyX2dyYXBoID0gZmlsdGVyX2dyYXBoOwoKZW5k
OgogICAgYXZmaWx0ZXJfaW5vdXRfZnJlZSgmaW5wdXRzKTsKICAgIGF2ZmlsdGVyX2lub3V0X2Zy
ZWUoJm91dHB1dHMpOwoKICAgIHJldHVybiByZXQ7Cn0KCnN0YXRpYyBpbnQgaW5pdF9maWx0ZXJz
KHZvaWQpCnsKICAgIGNvbnN0IGNoYXIgKmZpbHRlcl9zcGVjOwogICAgY2hhciB2ZmlsdGVyWzUx
Ml07CiAgICB1bnNpZ25lZCBpbnQgaTsKICAgIGludCByZXQ7CiAgICBmaWx0ZXJfY3R4ID0gYXZf
bWFsbG9jX2FycmF5KGlmbXRfY3R4LT5uYl9zdHJlYW1zLCBzaXplb2YoKmZpbHRlcl9jdHgpKTsK
ICAgIGlmICghZmlsdGVyX2N0eCkKICAgICAgICByZXR1cm4gQVZFUlJPUihFTk9NRU0pOwoKICAg
IGZvciAoaSA9IDA7IGkgPCBpZm10X2N0eC0+bmJfc3RyZWFtczsgaSsrKSB7CiAgICAgICAgZmls
dGVyX2N0eFtpXS5idWZmZXJzcmNfY3R4ICA9IE5VTEw7CiAgICAgICAgZmlsdGVyX2N0eFtpXS5i
dWZmZXJzaW5rX2N0eCA9IE5VTEw7CiAgICAgICAgZmlsdGVyX2N0eFtpXS5maWx0ZXJfZ3JhcGgg
ICA9IE5VTEw7CgogICAgICAgIGlmICghKGlmbXRfY3R4LT5zdHJlYW1zW2ldLT5jb2RlY3Bhci0+
Y29kZWNfdHlwZSA9PSBBVk1FRElBX1RZUEVfVklERU8pKQogICAgICAgICAgICBjb250aW51ZTsK
CgogICAgICAgIGlmIChpZm10X2N0eC0+c3RyZWFtc1tpXS0+Y29kZWNwYXItPmNvZGVjX3R5cGUg
PT0gQVZNRURJQV9UWVBFX1ZJREVPKSB7CgkgICAgc25wcmludGYodmZpbHRlciwgc2l6ZW9mKHZm
aWx0ZXIpLCAic2NhbGU9JWQ6JWQiLCBzdHJlYW1fY3R4W2ldLmVuY19jdHgtPndpZHRoLCBzdHJl
YW1fY3R4W2ldLmVuY19jdHgtPmhlaWdodCk7CgkgICAgZmlsdGVyX3NwZWMgPSB2ZmlsdGVyOwoJ
fQogICAgICAgIHJldCA9IGluaXRfZmlsdGVyKCZmaWx0ZXJfY3R4W2ldLCBzdHJlYW1fY3R4W2ld
LmRlY19jdHgsCiAgICAgICAgICAgICAgICBzdHJlYW1fY3R4W2ldLmVuY19jdHgsIGZpbHRlcl9z
cGVjKTsKICAgICAgICBpZiAocmV0KQogICAgICAgICAgICByZXR1cm4gcmV0OwoKICAgICAgICBm
aWx0ZXJfY3R4W2ldLmVuY19wa3QgPSBhdl9wYWNrZXRfYWxsb2MoKTsKICAgICAgICBpZiAoIWZp
bHRlcl9jdHhbaV0uZW5jX3BrdCkKICAgICAgICAgICAgcmV0dXJuIEFWRVJST1IoRU5PTUVNKTsK
CiAgICAgICAgZmlsdGVyX2N0eFtpXS5maWx0ZXJlZF9mcmFtZSA9IGF2X2ZyYW1lX2FsbG9jKCk7
CiAgICAgICAgaWYgKCFmaWx0ZXJfY3R4W2ldLmZpbHRlcmVkX2ZyYW1lKQogICAgICAgICAgICBy
ZXR1cm4gQVZFUlJPUihFTk9NRU0pOwogICAgfQogICAgcmV0dXJuIDA7Cn0KCnN0YXRpYyBpbnQg
ZW5jb2RlX3dyaXRlX2ZyYW1lKHVuc2lnbmVkIGludCBzdHJlYW1faW5kZXgsIGludCBmbHVzaCkK
ewogICAgU3RyZWFtQ29udGV4dCAqc3RyZWFtID0gJnN0cmVhbV9jdHhbc3RyZWFtX2luZGV4XTsK
ICAgIEZpbHRlcmluZ0NvbnRleHQgKmZpbHRlciA9ICZmaWx0ZXJfY3R4W3N0cmVhbV9pbmRleF07
CiAgICBBVkZyYW1lICpmaWx0X2ZyYW1lID0gZmx1c2ggPyBOVUxMIDogZmlsdGVyLT5maWx0ZXJl
ZF9mcmFtZTsKICAgIEFWUGFja2V0ICplbmNfcGt0ID0gZmlsdGVyLT5lbmNfcGt0OwogICAgaW50
IHJldDsKCiAgICBhdl9sb2coTlVMTCwgQVZfTE9HX0lORk8sICJFbmNvZGluZyBmcmFtZVxuIik7
CiAgICAvKiBlbmNvZGUgZmlsdGVyZWQgZnJhbWUgKi8KICAgIGF2X3BhY2tldF91bnJlZihlbmNf
cGt0KTsKIAogICAgcmV0ID0gYXZjb2RlY19zZW5kX2ZyYW1lKHN0cmVhbS0+ZW5jX2N0eCwgZmls
dF9mcmFtZSk7CgogICAgaWYgKHJldCA8IDApCiAgICAgICAgcmV0dXJuIHJldDsKCiAgICB3aGls
ZSAocmV0ID49IDApIHsKICAgICAgICByZXQgPSBhdmNvZGVjX3JlY2VpdmVfcGFja2V0KHN0cmVh
bS0+ZW5jX2N0eCwgZW5jX3BrdCk7CgogICAgICAgIGlmIChyZXQgPT0gQVZFUlJPUihFQUdBSU4p
IHx8IHJldCA9PSBBVkVSUk9SX0VPRikKICAgICAgICAgICAgcmV0dXJuIDA7CgogICAgICAgIC8q
IHByZXBhcmUgcGFja2V0IGZvciBtdXhpbmcgKi8KICAgICAgICBlbmNfcGt0LT5zdHJlYW1faW5k
ZXggPSBzdHJlYW1faW5kZXg7CiAgICAgICAgYXZfcGFja2V0X3Jlc2NhbGVfdHMoZW5jX3BrdCwK
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW0tPmVuY19jdHgtPnRpbWVfYmFzZSwK
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvZm10X2N0eC0+c3RyZWFtc1tzdHJlYW1faW5k
ZXhdLT50aW1lX2Jhc2UpOwoKICAgICAgICBhdl9sb2coTlVMTCwgQVZfTE9HX0RFQlVHLCAiTXV4
aW5nIGZyYW1lXG4iKTsKICAgICAgICAvKiBtdXggZW5jb2RlZCBmcmFtZSAqLwogICAgICAgIHJl
dCA9IGF2X2ludGVybGVhdmVkX3dyaXRlX2ZyYW1lKG9mbXRfY3R4LCBlbmNfcGt0KTsKICAgIH0K
CiAgICByZXR1cm4gcmV0Owp9CgpzdGF0aWMgaW50IGZpbHRlcl9lbmNvZGVfd3JpdGVfZnJhbWUo
QVZGcmFtZSAqZnJhbWUsIHVuc2lnbmVkIGludCBzdHJlYW1faW5kZXgpCnsKICAgIEZpbHRlcmlu
Z0NvbnRleHQgKmZpbHRlciA9ICZmaWx0ZXJfY3R4W3N0cmVhbV9pbmRleF07CiAgICBpbnQgcmV0
OwoKICAgIGF2X2xvZyhOVUxMLCBBVl9MT0dfSU5GTywgIlB1c2hpbmcgZGVjb2RlZCBmcmFtZSB0
byBmaWx0ZXJzXG4iKTsKICAgIC8qIHB1c2ggdGhlIGRlY29kZWQgZnJhbWUgaW50byB0aGUgZmls
dGVyZ3JhcGggKi8KICAgIHJldCA9IGF2X2J1ZmZlcnNyY19hZGRfZnJhbWVfZmxhZ3MoZmlsdGVy
LT5idWZmZXJzcmNfY3R4LAogICAgICAgICAgICBmcmFtZSwgMCk7CiAgICBpZiAocmV0IDwgMCkg
ewogICAgICAgIGF2X2xvZyhOVUxMLCBBVl9MT0dfRVJST1IsICJFcnJvciB3aGlsZSBmZWVkaW5n
IHRoZSBmaWx0ZXJncmFwaFxuIik7CiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0KCiAgICAvKiBw
dWxsIGZpbHRlcmVkIGZyYW1lcyBmcm9tIHRoZSBmaWx0ZXJncmFwaCAqLwogICAgd2hpbGUgKDEp
IHsKICAgICAgICBhdl9sb2coTlVMTCwgQVZfTE9HX0lORk8sICJQdWxsaW5nIGZpbHRlcmVkIGZy
YW1lIGZyb20gZmlsdGVyc1xuIik7CiAgICAgICAgcmV0ID0gYXZfYnVmZmVyc2lua19nZXRfZnJh
bWUoZmlsdGVyLT5idWZmZXJzaW5rX2N0eCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICBmaWx0ZXItPmZpbHRlcmVkX2ZyYW1lKTsKICAgICAgICBpZiAocmV0IDwgMCkgewog
ICAgICAgICAgICAvKiBpZiBubyBtb3JlIGZyYW1lcyBmb3Igb3V0cHV0IC0gcmV0dXJucyBBVkVS
Uk9SKEVBR0FJTikKICAgICAgICAgICAgICogaWYgZmx1c2hlZCBhbmQgbm8gbW9yZSBmcmFtZXMg
Zm9yIG91dHB1dCAtIHJldHVybnMgQVZFUlJPUl9FT0YKICAgICAgICAgICAgICogcmV3cml0ZSBy
ZXRjb2RlIHRvIDAgdG8gc2hvdyBpdCBhcyBub3JtYWwgcHJvY2VkdXJlIGNvbXBsZXRpb24KICAg
ICAgICAgICAgICovCiAgICAgICAgICAgIGlmIChyZXQgPT0gQVZFUlJPUihFQUdBSU4pIHx8IHJl
dCA9PSBBVkVSUk9SX0VPRikKICAgICAgICAgICAgICAgIHJldCA9IDA7CiAgICAgICAgICAgIGJy
ZWFrOwogICAgICAgIH0KIAogICAgICAgIGZpbHRlci0+ZmlsdGVyZWRfZnJhbWUtPnBpY3RfdHlw
ZSA9IEFWX1BJQ1RVUkVfVFlQRV9OT05FOwogICAgICAgIHJldCA9IGVuY29kZV93cml0ZV9mcmFt
ZShzdHJlYW1faW5kZXgsIDApOwogICAgICAgIGF2X2ZyYW1lX3VucmVmKGZpbHRlci0+ZmlsdGVy
ZWRfZnJhbWUpOwogICAgICAgIGlmIChyZXQgPCAwKQogICAgICAgICAgICBicmVhazsKICAgIH0K
CiAgICByZXR1cm4gcmV0Owp9CgpzdGF0aWMgaW50IGZsdXNoX2VuY29kZXIodW5zaWduZWQgaW50
IHN0cmVhbV9pbmRleCkKewogICAgaWYgKCEoc3RyZWFtX2N0eFtzdHJlYW1faW5kZXhdLmVuY19j
dHgtPmNvZGVjLT5jYXBhYmlsaXRpZXMgJgogICAgICAgICAgICAgICAgQVZfQ09ERUNfQ0FQX0RF
TEFZKSkKICAgICAgICByZXR1cm4gMDsKCiAgICBhdl9sb2coTlVMTCwgQVZfTE9HX0lORk8sICJG
bHVzaGluZyBzdHJlYW0gIyV1IGVuY29kZXJcbiIsIHN0cmVhbV9pbmRleCk7CiAgICByZXR1cm4g
ZW5jb2RlX3dyaXRlX2ZyYW1lKHN0cmVhbV9pbmRleCwgMSk7Cn0KCmludCB0aHVtYihjaGFyKiBj
YWxsZXIsIGNoYXIqIGluLCBjaGFyKiBvdXQsIGNoYXIqIHdpZHRoLCBjaGFyKiBoZWlnaHQpCnsK
ICAgIGludCByZXQ7CiAgICBBVlBhY2tldCAqcGFja2V0ID0gTlVMTDsKICAgIHVuc2lnbmVkIGlu
dCBzdHJlYW1faW5kZXg7CiAgICB1bnNpZ25lZCBpbnQgaTsKICAgIGNoYXIgKm1heF93X2VuZDsK
ICAgIGNoYXIgKm1heF9oX2VuZDsKCiAgICBpZiAoKHJldCA9IG9wZW5faW5wdXRfZmlsZShpbikp
IDwgMCkKICAgICAgICBnb3RvIGVuZDsKICAgIGlmICgocmV0ID0gb3Blbl9vdXRwdXRfZmlsZShv
dXQsIHN0cnRvdWwod2lkdGgsICZtYXhfd19lbmQsIDEwKSwgc3RydG91bChoZWlnaHQsICZtYXhf
aF9lbmQsIDEwKSkpIDwgMCkKICAgICAgICBnb3RvIGVuZDsKICAgIGlmICgocmV0ID0gaW5pdF9m
aWx0ZXJzKCkpIDwgMCkKICAgICAgICBnb3RvIGVuZDsKICAgIGlmICghKHBhY2tldCA9IGF2X3Bh
Y2tldF9hbGxvYygpKSkKICAgICAgICBnb3RvIGVuZDsKCiAgICBpbnQgc2VlayA9IDA7CgogICAg
LyogcmVhZCBhbGwgcGFja2V0cyAqLwogICAgd2hpbGUgKDEpIHsKCQoKICAgICAgICBpZiAoKHJl
dCA9IGF2X3JlYWRfZnJhbWUoaWZtdF9jdHgsIHBhY2tldCkpIDwgMCkKICAgICAgICAgICAgYnJl
YWs7CgogICAgICAgIHN0cmVhbV9pbmRleCA9IHBhY2tldC0+c3RyZWFtX2luZGV4OwogICAgICAg
IGF2X2xvZyhOVUxMLCBBVl9MT0dfREVCVUcsICJEZW11eGVyIGdhdmUgZnJhbWUgb2Ygc3RyZWFt
X2luZGV4ICV1XG4iLAogICAgICAgICAgICAgICAgc3RyZWFtX2luZGV4KTsKCiAgICAgICAgaWYg
KGZpbHRlcl9jdHhbc3RyZWFtX2luZGV4XS5maWx0ZXJfZ3JhcGgpIHsKICAgICAgICAgICAgU3Ry
ZWFtQ29udGV4dCAqc3RyZWFtID0gJnN0cmVhbV9jdHhbc3RyZWFtX2luZGV4XTsKCgkgICAgIC8v
aW50NjRfdCBzZWVrVGFyZ2V0ID0gaW50NjRfdCgxMCkgKiB0aW1lQmFzZTsKCiAgICAgICAgICAg
ICAvL2lmKGF2X3NlZWtfZnJhbWUoKnN0cmVhbSwgLTEsIHNlZWtUYXJnZXQsIEFWU0VFS19GTEFH
X0FOWSkgPCAwKQogICAgICAgICAgICAgICAvLyAgICBtZXhFcnJNc2dUeHQoImF2X3NlZWtfZnJh
bWUgZmFpbGVkLiIpOwoKCgogICAgICAgICAgICBhdl9sb2coTlVMTCwgQVZfTE9HX0RFQlVHLCAi
R29pbmcgdG8gcmVlbmNvZGUmZmlsdGVyIHRoZSBmcmFtZVxuIik7CiAKICAgICAgICAgICAgYXZf
cGFja2V0X3Jlc2NhbGVfdHMocGFja2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICBpZm10X2N0eC0+c3RyZWFtc1tzdHJlYW1faW5kZXhdLT50aW1lX2Jhc2UsCiAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbS0+ZGVjX2N0eC0+dGltZV9iYXNlKTsKICAgICAg
ICAgICAgcmV0ID0gYXZjb2RlY19zZW5kX3BhY2tldChzdHJlYW0tPmRlY19jdHgsIHBhY2tldCk7
CiAgICAgICAgICAgIGlmIChyZXQgPCAwKSB7CiAgICAgICAgICAgICAgICBhdl9sb2coTlVMTCwg
QVZfTE9HX0VSUk9SLCAiRGVjb2RpbmcgZmFpbGVkXG4iKTsKICAgICAgICAgICAgICAgIGJyZWFr
OwogICAgICAgICAgICB9CgoKCiAgICAgICAgICAgIHdoaWxlIChyZXQgPj0gMCkgewogICAgICAg
ICAgICAgICAgcmV0ID0gYXZjb2RlY19yZWNlaXZlX2ZyYW1lKHN0cmVhbS0+ZGVjX2N0eCwgc3Ry
ZWFtLT5kZWNfZnJhbWUpOwogICAgICAgICAgICAgICAgaWYgKHJldCA9PSBBVkVSUk9SX0VPRiB8
fCByZXQgPT0gQVZFUlJPUihFQUdBSU4pKQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAg
ICAgICAgICAgICAgZWxzZSBpZiAocmV0IDwgMCkKICAgICAgICAgICAgICAgICAgICBnb3RvIGVu
ZDsKCiAgICAgICAgICAgICAgICBzdHJlYW0tPmRlY19mcmFtZS0+cHRzID0gc3RyZWFtLT5kZWNf
ZnJhbWUtPmJlc3RfZWZmb3J0X3RpbWVzdGFtcDsKCgkJCi8vaWYgKHNlZWsgPCAxNikgewovLwkg
IHNlZWsrKzsKLy8JICBjb250aW51ZTsKLy8JfQoKICAgICAgICAgICAgICAgIHJldCA9IGZpbHRl
cl9lbmNvZGVfd3JpdGVfZnJhbWUoc3RyZWFtLT5kZWNfZnJhbWUsIHN0cmVhbV9pbmRleCk7CiAg
ICAgICAgICAgICAgICBpZiAocmV0IDwgMCkKICAgICAgICAgICAgICAgICAgICBnb3RvIGVuZDsK
CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0gCiAgICAgICAg
YnJlYWs7CiAgICAgICAgYXZfcGFja2V0X3VucmVmKHBhY2tldCk7CiAgICB9CgogICAgLyogZmx1
c2ggZGVjb2RlcnMsIGZpbHRlcnMgYW5kIGVuY29kZXJzICovCiAgICBmb3IgKGkgPSAwOyBpIDwg
aWZtdF9jdHgtPm5iX3N0cmVhbXM7IGkrKykgewogICAgICAgIFN0cmVhbUNvbnRleHQgKnN0cmVh
bTsKCiAgICAgICAgaWYgKCFmaWx0ZXJfY3R4W2ldLmZpbHRlcl9ncmFwaCkKICAgICAgICAgICAg
Y29udGludWU7CgogICAgICAgIHN0cmVhbSA9ICZzdHJlYW1fY3R4W2ldOwoKICAgICAgICBhdl9s
b2coTlVMTCwgQVZfTE9HX0lORk8sICJGbHVzaGluZyBzdHJlYW0gJXUgZGVjb2RlclxuIiwgaSk7
CgogICAgICAgIC8qIGZsdXNoIGRlY29kZXIgKi8KICAgICAgICByZXQgPSBhdmNvZGVjX3NlbmRf
cGFja2V0KHN0cmVhbS0+ZGVjX2N0eCwgTlVMTCk7CiAgICAgICAgaWYgKHJldCA8IDApIHsKICAg
ICAgICAgICAgYXZfbG9nKE5VTEwsIEFWX0xPR19FUlJPUiwgIkZsdXNoaW5nIGRlY29kaW5nIGZh
aWxlZFxuIik7CiAgICAgICAgICAgIGdvdG8gZW5kOwogICAgICAgIH0KCiAgICAgICAgd2hpbGUg
KHJldCA+PSAwKSB7CiAgICAgICAgICAgIHJldCA9IGF2Y29kZWNfcmVjZWl2ZV9mcmFtZShzdHJl
YW0tPmRlY19jdHgsIHN0cmVhbS0+ZGVjX2ZyYW1lKTsKICAgICAgICAgICAgaWYgKHJldCA9PSBB
VkVSUk9SX0VPRikKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBlbHNlIGlmIChy
ZXQgPCAwKQogICAgICAgICAgICAgICAgZ290byBlbmQ7CgogICAgICAgICAgICBzdHJlYW0tPmRl
Y19mcmFtZS0+cHRzID0gc3RyZWFtLT5kZWNfZnJhbWUtPmJlc3RfZWZmb3J0X3RpbWVzdGFtcDsK
ICAgICAgICAgICAgcmV0ID0gZmlsdGVyX2VuY29kZV93cml0ZV9mcmFtZShzdHJlYW0tPmRlY19m
cmFtZSwgaSk7CiAgICAgICAgICAgIGlmIChyZXQgPCAwKQogICAgICAgICAgICAgICAgZ290byBl
bmQ7CiAgICAgICAgfQoKICAgICAgICAvKiBmbHVzaCBmaWx0ZXIgKi8KICAgICAgICByZXQgPSBm
aWx0ZXJfZW5jb2RlX3dyaXRlX2ZyYW1lKE5VTEwsIGkpOwogICAgICAgIGlmIChyZXQgPCAwKSB7
CiAgICAgICAgICAgIGF2X2xvZyhOVUxMLCBBVl9MT0dfRVJST1IsICJGbHVzaGluZyBmaWx0ZXIg
ZmFpbGVkXG4iKTsKICAgICAgICAgICAgZ290byBlbmQ7CiAgICAgICAgfQoKICAgICAgICAvKiBm
bHVzaCBlbmNvZGVyICovCiAgICAgICAgcmV0ID0gZmx1c2hfZW5jb2RlcihpKTsKICAgICAgICBp
ZiAocmV0IDwgMCkgewogICAgICAgICAgICBhdl9sb2coTlVMTCwgQVZfTE9HX0VSUk9SLCAiRmx1
c2hpbmcgZW5jb2RlciBmYWlsZWRcbiIpOwogICAgICAgICAgICBnb3RvIGVuZDsKICAgICAgICB9
CiAgICB9CgogICAgYXZfd3JpdGVfdHJhaWxlcihvZm10X2N0eCk7CmVuZDoKICAgIGF2X3BhY2tl
dF9mcmVlKCZwYWNrZXQpOwogICAgZm9yIChpID0gMDsgaSA8IGlmbXRfY3R4LT5uYl9zdHJlYW1z
OyBpKyspIHsKICAgICAgICBhdmNvZGVjX2ZyZWVfY29udGV4dCgmc3RyZWFtX2N0eFtpXS5kZWNf
Y3R4KTsKICAgICAgICBpZiAob2ZtdF9jdHggJiYgb2ZtdF9jdHgtPm5iX3N0cmVhbXMgPiBpICYm
IG9mbXRfY3R4LT5zdHJlYW1zW2ldICYmIHN0cmVhbV9jdHhbaV0uZW5jX2N0eCkKICAgICAgICAg
ICAgYXZjb2RlY19mcmVlX2NvbnRleHQoJnN0cmVhbV9jdHhbaV0uZW5jX2N0eCk7CiAgICAgICAg
aWYgKGZpbHRlcl9jdHggJiYgZmlsdGVyX2N0eFtpXS5maWx0ZXJfZ3JhcGgpIHsKICAgICAgICAg
ICAgYXZmaWx0ZXJfZ3JhcGhfZnJlZSgmZmlsdGVyX2N0eFtpXS5maWx0ZXJfZ3JhcGgpOwogICAg
ICAgICAgICBhdl9wYWNrZXRfZnJlZSgmZmlsdGVyX2N0eFtpXS5lbmNfcGt0KTsKICAgICAgICAg
ICAgYXZfZnJhbWVfZnJlZSgmZmlsdGVyX2N0eFtpXS5maWx0ZXJlZF9mcmFtZSk7CiAgICAgICAg
fQoKICAgICAgICBhdl9mcmFtZV9mcmVlKCZzdHJlYW1fY3R4W2ldLmRlY19mcmFtZSk7CiAgICB9
CiAgICBhdl9mcmVlKGZpbHRlcl9jdHgpOwogICAgYXZfZnJlZShzdHJlYW1fY3R4KTsKICAgIGF2
Zm9ybWF0X2Nsb3NlX2lucHV0KCZpZm10X2N0eCk7CiAgICBpZiAob2ZtdF9jdHggJiYgIShvZm10
X2N0eC0+b2Zvcm1hdC0+ZmxhZ3MgJiBBVkZNVF9OT0ZJTEUpKQogICAgICAgIGF2aW9fY2xvc2Vw
KCZvZm10X2N0eC0+cGIpOwogICAgYXZmb3JtYXRfZnJlZV9jb250ZXh0KG9mbXRfY3R4KTsKCiAg
ICBpZiAocmV0IDwgMCkKICAgICAgICBhdl9sb2coTlVMTCwgQVZfTE9HX0VSUk9SLCAiRXJyb3Ig
b2NjdXJyZWQ6ICVzXG4iLCBhdl9lcnIyc3RyKHJldCkpOwoKICAgIHJldHVybiByZXQgPyAxIDog
MDsKfQoKaW50IG1haW4gKGludCBhcmdjLCBjaGFyKiogYXJndikgewogIHJldHVybiAwOwp9Cgov
L2ludCBwcm9iZQo=
};
  $code = decode_base64($code);
  say
}

state $config = {
  tn => {
    default_format => "avif",
    default_name => sub { __PACKAGE__->tnfn },
    width => 250,
    height => 250
  }
};

use Inline C => Config =>
  => BUILD_NOISY => 1
  => enable => "autowrap"
  => LIBS => "-lavformat -lavcodec -lavdevice -lavfilter -lavutil -lswscale -lswresample -lz";

use Inline C => "$code"
  => BUILD_NOISY => 1
  => enable => "autowrap"
  => LIBS => "-lavformat -lavcodec -lavdevice -lavfilter -lavutil -lswscale -lswresample -lz";

method show_self {
  p $self
}

method tnfn :common {
  (join '', Time::HiRes::gettimeofday) . "." . $config->{tn}{default_format}
}

method codec_id :common ($extension) {
  state %codecmap = (
    jxl => 'AV_CODEC_ID_JPEGXL',
    avif => 'AV_CODEC_ID_AV1'
  );

  $codecmap{$extension}
}

method thumbnail :common ($in, $out = './' . $config->{tn}{default_name}->()
  , $width = $config->{tn}{width}, $height = $config->{tn}{height}
  , $codecid = $class->codec_id($config->{tn}{default_format})) {

  my @io = map { "$_" } (path($in)->absolute, path($out)->absolute);
  my $ret;

  try {
    $ret = FFmpeg::Inline::thumb($0, @io, "$width", "$height");
  }
  catch ($e) {
    p $e
  }

  $ret
}

__END__

=encoding utf-8

=head1 NAME

FFmpeg::Inline - Bindings to FFmpeg/libav via Inline::C

=head1 SYNOPSIS

    use FFmpeg::Inline;

=head1 DESCRIPTION

FFmpeg::Inline is ...

=head1 LICENSE

Copyright (C) Ian P Bradley.

This library is free software; you can redistribute it and/or modify
it under the same terms as Perl itself.

=head1 AUTHOR

Ian P Bradley E<lt>ian.bradley@studiocrabapple.comE<gt>

=cut

